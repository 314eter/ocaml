#!/bin/bash

#########################################################################
#                                                                       #
#                                 OCaml                                 #
#                                                                       #
#                Damien Doligez, Jane Street Capital                    #
#                                                                       #
#   Copyright 2014 Institut National de Recherche en Informatique et    #
#   en Automatique.  All rights reserved.  This file is distributed     #
#   under the terms of the Q Public License version 1.0.                #
#                                                                       #
#########################################################################

[ -z "$Tdebug" ] || set -x

Pfile="$1"
Pdir="`dirname $1`"
Pbase="`basename $1 .t`"
Pexec="$Pbase".exe

# todo:
# 1. make "custom" user-settable
# 2. transmit the value of "custom" to Trun (if custom, do not use ocamlrun)

Pocamlrun="$TOPDIR/boot/ocamlrun$EXE"
Pflags="-nostdlib -I $OTOPDIR/stdlib"
Pocamlc="$Pocamlrun $OTOPDIR/ocamlc $Pflags"
Pocamlopt="$Pocamlrun $OTOPDIR/ocamlopt $Pflags"
Pocaml="$Pocamlrun $OTOPDIR/ocaml $Pflags \
        -init $OTOPDIR/testsuite/scripts/empty"
Pocamldoc="$Pocamlrun $OTOPDIR/ocamldoc/ocamldoc"
Plex="$Pocamlrun $OTOPDIR/lex/ocamllex"
Pyacc="$TOPDIR/yacc/ocamlyacc$EXE"
Pocamlmklib="$Pocamlrun $OTOPDIR/tools/ocamlmklib \
             -ocamlc '$OTOPDIR/boot/ocamlrun$EXE $OTOPDIR/ocamlc $Pflags' \
             -ocamlopt '$OTOPDIR/boot/ocamlrun$EXE $OTOPDIR/ocamlopt $Pflags'"
if [ "$ARCH" = none -o "$ASM" = none ]; then
  Pwith_asm=false
else
  Pwith_asm=true
fi

if $SUPPORTS_SHARED_LIBRARIES; then
  Tcustom=
else
  Tcustom=-custom
fi

Tml_files="$Pbase.ml"
Tmli_files=
Tmll_files=
Tmly_files=

Ttests="Tbyte_compile_run Topt_compile_run"

Tcompflags=
Tbyteflags=
Toptflags=
Tlexflags=
Tyaccflags=

Texec_env=
Targs=
Texit=0

# Log the command and execute it
Plog () {
    echo "$*" >&2
    eval "$*"
}

# Same as Plog, but don't fail if the command fails, and save the
# result code
Plogr () {
    echo "$*" >&2
    Pactualexit=0
    eval "$*" || Pactualexit=$?
}

Tlex_yacc_gen () {
    for f in $Tmll_files; do
        Plog $Plex $Tlexflags $f
    done
    for f in $Tmly_files; do
        Plog $Pyacc $Tyaccflags $f
    done
}

Tbyte_compile () {
    Tprepare
    Tlex_yacc_gen
    Plog $Pocamlc $Tcompflags $Tcustom $Tbyteflags $Tmli_files $Tml_files \
         -o $Pexec
}

Topt_compile () {
    Tprepare
    Tlex_yacc_gen
    Plog $Pocamlopt $Tcompflags $Toptflags $Tmli_files $Tml_files -o $Pexec
}

Tprint_command_default () {
    if [ -f $Pbase.in ]; then infile=$Pbase.in; else infile=/dev/null; fi
    echo ./$Pexec $Targs '<'$infile
}

Tbyte_run () {
    case $Tcustom in
        -custom) runtime=;;
        *) runtime=$Pocamlrun;;
    esac
    Plog $Texec_env $runtime `Tprint_command` \
         '>'$Pbase.tmp_out '2>'$Pbase.tmp_err
}

Topt_run () {
    Plog $Texec_env `Tprint_command` \
         '>'$Pbase.tmp_out '2>'$Pbase.tmp_err
}

Tmultiple () {
    command="$1"
    shift
    for i in $*; do
        eval "${command}_$i () {
            Targs=\"\$Targs_$i\";
            Texit=\"\${Texit_$i:-0}\";
            Pbase=\"\$Pbase-$i\";
            $command;
        }"
        Ttests="$Ttests ${command}_$i"
    done
}

Tbyte_compile_run () {
    Tbyte_compile
    Tbyte_run
}

Topt_compile_run () {
    Topt_compile
    Topt_run
}

Tcompare_files_default () {
    ref="$1"
    act="$2"
    if [ ! -f "$ref" ]; then ref=/dev/null; fi
    Tpostprocess "$act" > "${act}_pp"
    Plog cmp "$ref" "${act}_pp"
}

Tpostprocess_none () {
    cat "$1"
}

Tpostprocess_sort () {
    Plog sort "$1"
}

Tpostprocess_sort_uniq () {
    Plog sort "$1" '|' uniq
}

Tpostcheck_default () {
    for suff in out err; do
        if [ -f $Pbase.tmp_$suff ]; then
            Tcompare_files $Pbase.$suff $Pbase.tmp_$suff
        fi
    done
    [ "$Pactualexit" -eq "$Texit" ] || {
        printf "ERROR: actual exit code %d is different from expected %d\n" \
               $Pactualexit $Texit
        false
    }
}

Tprecheck_default () {
    case $Pwith_asm/$Tcommand in
        false/Topt_*) false;;
        *) true;;
    esac
}

#override me
Tprepare () {
    :
}

# override me
Tprint_command () {
    Tprint_command_default
}

# override me
Tcompare_files () {
    Tcompare_files_default "$@"
}

#override me
Tpostprocess () {
    Tpostprocess_none "$@"
}

#override me
Tpostcheck () {
    Tpostcheck_default
}

#override me
Tprecheck () {
    Tprecheck_default
}

Pexport_variables () {
    export OCAMLYACC="$Pyacc"
    export OCAMLLEX="$Plex"
    export OCAMLC="$Pocamlc"
    export OCAMLRUN="$Pocamlrun"
}

Pstart_test () {
    printf "Testing %s with %s..." "$Pfile" "$Tcommand" >&3
    printf "#################################################"
    printf "\nTesting %s with %s...\n" "$Pfile" "$Tcommand"
}

Pskip_test () {
    printf "skip\n" >&3
    printf "skip\n\n"
    exit 0
}

Pfail_test () {
    printf "FAIL\n" >&3
    printf "FAIL\n\n"
    exit 0
}

Ppass_test () {
    printf "pass\n" >&3
    printf "pass\n\n"
}

cd "$Pdir"

######################################################
. $Pbase.t
######################################################

for Tcommand in $Ttests; do
    Pstart_test
    (
        Tprecheck || Pskip_test
        rm -f "$Pbase".tmp_*
        Pactualexit=0
        (
            set -e
            $Tcommand || Pactualexit=$?
            echo Texit=$Texit
            Tpostcheck
        )
        case $? in
            0) Ppass_test;;
            *) Pfail_test;;
        esac
    )
done
